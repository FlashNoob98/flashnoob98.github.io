<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Questionario HSEQ — 10 domande random</title>
  <style>
    :root { --bg:#0b1220; --card:#111a2e; --text:#e9eefc; --muted:#aab6d3; --ok:#22c55e; --bad:#ef4444; --accent:#60a5fa; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; background: var(--bg); color: var(--text); }
    .wrap { max-width: 980px; margin: 24px auto; padding: 0 16px; }
    .card { background: var(--card); border: 1px solid rgba(255,255,255,.08); border-radius: 14px; padding: 18px; box-shadow: 0 10px 30px rgba(0,0,0,.25); }
    h1 { font-size: 20px; margin: 0 0 10px; }
    .meta { color: var(--muted); font-size: 13px; margin-bottom: 14px; display:flex; gap:12px; flex-wrap:wrap; }
    .pill { display:inline-flex; align-items:center; gap:6px; padding: 4px 10px; border-radius: 999px; border:1px solid rgba(255,255,255,.12); background: rgba(255,255,255,.04); }
    .progress { height: 8px; background: rgba(255,255,255,.08); border-radius: 999px; overflow:hidden; margin: 14px 0 6px; }
    .bar { height: 100%; width:0%; background: rgba(96,165,250,.9); }
    .small { font-size: 12px; color: var(--muted); }
    .q { font-size: 16px; margin: 0 0 12px; line-height: 1.35; }
    .opts { display: grid; gap: 10px; }
    button.opt { text-align:left; padding: 12px; border-radius: 12px; border: 1px solid rgba(255,255,255,.12); background: rgba(255,255,255,.04); color: var(--text); cursor:pointer; }
    button.opt:hover { border-color: rgba(96,165,250,.7); }
    button.opt[disabled] { cursor: default; opacity: .92; }
    .feedback { margin-top: 12px; padding: 12px; border-radius: 12px; border: 1px solid rgba(255,255,255,.10); background: rgba(255,255,255,.03); }
    .feedback.ok { border-color: rgba(34,197,94,.6); }
    .feedback.bad { border-color: rgba(239,68,68,.6); }
    a { color: var(--accent); text-decoration: none; }
    a:hover { text-decoration: underline; }
    .controls { display:flex; gap:10px; margin-top: 14px; flex-wrap: wrap; }
    .btn { padding: 10px 12px; border-radius: 12px; border: 1px solid rgba(255,255,255,.14); background: rgba(255,255,255,.05); color: var(--text); cursor:pointer; }
    .btn.primary { border-color: rgba(96,165,250,.7); }
    .score { font-weight: 600; }
    code { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }

    /* Topic picker */
    .picker { margin: 12px 0 8px; padding: 12px; border-radius: 12px; border: 1px solid rgba(255,255,255,.10); background: rgba(255,255,255,.03); }
    .pickerHead { display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap; }
    .pickerTitle { font-weight:600; }
    .pickerBtns { display:flex; gap:8px; flex-wrap:wrap; }
    .pickerList { display:grid; gap:8px; margin-top:10px; }
    .row { display:flex; align-items:center; gap:10px; padding:6px 0; }
    .row span { flex:1; }
    .count { opacity:.75; }
    .warn { color: #fbbf24; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Questionario HSEQ — 10 domande random</h1>

      <div class="meta">
        <span class="pill">Domanda <span id="idx">1</span>/10</span>
        <span class="pill">Punteggio <span class="score" id="score">0</span></span>
        <span class="pill">Seed <span id="seed"></span></span>
        <span class="pill">Domande totali <span id="poolSize">-</span></span>
      </div>

    <!-- Selettore argomenti (collassabile) -->
    <div class="picker" id="topicPicker" style="display:none;">
    <button class="pickerRow" id="pickerToggle" type="button" aria-expanded="false">
        <div class="pickerRowLeft">
        <div class="pickerTitle">Seleziona argomenti (pool)</div>
        <div class="small" id="pickerSummary">Caricamento…</div>
        </div>
        <div class="chev" id="pickerChev">▾</div>
    </button>

    <div class="pickerBody" id="pickerBody" style="display:none;">
        <div class="pickerBtns">
        <button class="btn" id="pickAll" type="button">Seleziona tutto</button>
        <button class="btn" id="pickNone" type="button">Deseleziona tutto</button>
        </div>

        <div class="pickerList" id="topicList"></div>
        <div class="small" id="topicHint" style="margin-top:10px;"></div>
    </div>
    </div>
    <!-- /Selettore argomenti -->

      <div class="progress"><div class="bar" id="bar"></div></div>
      <div class="small" id="topic"></div>

      <p class="q" id="question"></p>
      <div class="opts" id="options"></div>

      <div id="feedback"></div>

      <div class="controls">
        <button class="btn" id="next" disabled>Avanti</button>
        <button class="btn primary" id="restart">Nuovo quiz</button>
        <button class="btn" id="copyLink">Copia link (stesso seed)</button>
      </div>

    </div>
  </div>

<script>
  // ====== RNG / shuffle ======
  function mulberry32(a){return function(){let t=a+=0x6D2B79F5;t=Math.imul(t^t>>>15,t|1);t^=t+Math.imul(t^t>>>7,t|61);return((t^t>>>14)>>>0)/4294967296}}
  function shuffle(arr, rng){
    const a = arr.slice();
    for(let i=a.length-1;i>0;i--){
      const j = Math.floor(rng()*(i+1));
      [a[i], a[j]] = [a[j], a[i]];
    }
    return a;
  }
  function qs(name){
    const url = new URL(window.location.href);
    return url.searchParams.get(name);
  }
  function setQS(name, value){
    const url = new URL(window.location.href);
    url.searchParams.set(name, value);
    return url.toString();
  }

  // shuffle opzioni mantenendo la risposta corretta
  function shuffleOptionsKeepAnswer(question, rng){
    const opts = question.options.map((text, idx) => ({ text, idx }));
    for(let i = opts.length - 1; i > 0; i--){
      const j = Math.floor(rng() * (i + 1));
      [opts[i], opts[j]] = [opts[j], opts[i]];
    }
    const newOptions = opts.map(o => o.text);
    const newAnswerIndex = opts.findIndex(o => o.idx === question.answerIndex);
    return { ...question, options: newOptions, answerIndex: newAnswerIndex };
  }

  // ====== Validation ======
  function validateBank(bank, sourceName){
    if(!Array.isArray(bank) || bank.length === 0) throw new Error(`Bank vuoto/non valido: ${sourceName}`);
    bank.forEach((q, idx) => {
      const req = ["id","topic","q","options","answerIndex","refLabel","refUrl"];
      for (const k of req) {
        if(!(k in q)) throw new Error(`Manca campo '${k}' in ${sourceName} (idx ${idx})`);
      }
      if(!Array.isArray(q.options) || q.options.length < 2) throw new Error(`Options non valide: ${q.id}`);
      if(typeof q.answerIndex !== "number" || q.answerIndex < 0 || q.answerIndex >= q.options.length) {
        throw new Error(`answerIndex non valido: ${q.id}`);
      }
      if(typeof q.refUrl !== "string" || !q.refUrl.startsWith("http")) throw new Error(`refUrl non valido: ${q.id}`);
    });
  }

  // ====== App State ======
  let seed = Number(qs("seed")) || Math.floor(Math.random() * 1e9);
  let rng = mulberry32(seed);

  // Manifest + cache per bank
  let BANKS = [];                    // [{id,title,file}]
  const BANK_DATA = new Map();       // id -> { meta, questionsTagged, count }

  // Selezione utente (persistita)
  const LS_KEY = "selectedBanks_v1";
  let selectedBankIds = new Set();   // id

  // Pool effettivo (merge delle selezioni)
  let QUESTION_BANK = [];

  let quiz = [];
  let i = 0;
  let score = 0;
  let locked = false;

  const elIdx = document.getElementById("idx");
  const elScore = document.getElementById("score");
  const elSeed = document.getElementById("seed");
  const elPool = document.getElementById("poolSize");
  const elBar = document.getElementById("bar");
  const elTopic = document.getElementById("topic");
  const elQ = document.getElementById("question");
  const elOpts = document.getElementById("options");
  const elFb = document.getElementById("feedback");

  const btnNext = document.getElementById("next");
  const btnRestart = document.getElementById("restart");
  const btnCopy = document.getElementById("copyLink");

  const elPicker = document.getElementById("topicPicker");
  const elTopicList = document.getElementById("topicList");
  const elTopicHint = document.getElementById("topicHint");
  const btnPickAll = document.getElementById("pickAll");
  const btnPickNone = document.getElementById("pickNone");

  function saveSelection(){
    try {
      localStorage.setItem(LS_KEY, JSON.stringify(Array.from(selectedBankIds)));
    } catch(_) {}
  }
  function loadSelection(){
    try {
      const raw = localStorage.getItem(LS_KEY);
      if(!raw) return null;
      const arr = JSON.parse(raw);
      return Array.isArray(arr) ? arr : null;
    } catch(_) { return null; }
  }

  function uniqById(arr){
    const m = new Map();
    for(const q of arr) m.set(q.id, q);
    return Array.from(m.values());
  }

  function rebuildQuestionBankFromSelection(){
    let merged = [];
    for(const id of selectedBankIds){
      const b = BANK_DATA.get(id);
      if(b && Array.isArray(b.questionsTagged)) merged.push(...b.questionsTagged);
    }
    merged = uniqById(merged);

    QUESTION_BANK = merged;
    elPool.textContent = String(QUESTION_BANK.length);

    // KPI selezione
    const selectedCount = selectedBankIds.size;
    const totalSelectedQuestions = QUESTION_BANK.length;

    if(selectedCount === 0){
      elTopicHint.innerHTML = `<span class="warn">Seleziona almeno un argomento.</span>`;
      return false;
    }
    if(totalSelectedQuestions < 10){
      elTopicHint.innerHTML = `<span class="warn">Pool selezionato troppo piccolo: ${totalSelectedQuestions} (min 10). Seleziona più argomenti.</span>`;
      return false;
    }

    elTopicHint.textContent = `Attivi: ${selectedCount} argomenti — pool: ${totalSelectedQuestions} domande.`;
    return true;
  }

  function renderTopicPicker(){
    elPicker.style.display = "block";
    elTopicList.innerHTML = "";

    for(const b of BANKS){
      const data = BANK_DATA.get(b.id);
      const count = data ? data.count : 0;

      const row = document.createElement("label");
      row.className = "row";

      const cb = document.createElement("input");
      cb.type = "checkbox";
      cb.dataset.bankId = b.id;
      cb.checked = selectedBankIds.has(b.id);

      const title = document.createElement("span");
      title.textContent = b.title || b.id;

      const cnt = document.createElement("span");
      cnt.className = "count";
      cnt.textContent = `(${count})`;

      cb.addEventListener("change", () => {
        if(cb.checked) selectedBankIds.add(b.id);
        else selectedBankIds.delete(b.id);

        saveSelection();
        const ok = rebuildQuestionBankFromSelection();

        // se la selezione è valida, rigenera immediatamente il quiz mantenendo seed
        if(ok) buildQuiz();
        else {
          // blocca UI quiz finché non valido
          elTopic.textContent = "Selezione argomenti";
          elQ.textContent = "Pool non valido: seleziona più argomenti per avviare il quiz.";
          elOpts.innerHTML = "";
          elFb.innerHTML = "";
          btnNext.disabled = true;
          elBar.style.width = "0%";
          elIdx.textContent = "1";
          elScore.textContent = "0";
        }
      });

      row.appendChild(cb);
      row.appendChild(title);
      row.appendChild(cnt);

      elTopicList.appendChild(row);
    }

    btnPickAll.onclick = () => {
      selectedBankIds = new Set(BANKS.map(b => b.id));
      saveSelection();
      // aggiorna checkbox
      elTopicList.querySelectorAll('input[type="checkbox"][data-bank-id]').forEach(cb => cb.checked = true);
      if(rebuildQuestionBankFromSelection()) buildQuiz();
    };

    btnPickNone.onclick = () => {
      selectedBankIds.clear();
      saveSelection();
      elTopicList.querySelectorAll('input[type="checkbox"][data-bank-id]').forEach(cb => cb.checked = false);
      rebuildQuestionBankFromSelection();
      elTopic.textContent = "Selezione argomenti";
      elQ.textContent = "Seleziona almeno un argomento per avviare il quiz.";
      elOpts.innerHTML = "";
      elFb.innerHTML = "";
      btnNext.disabled = true;
      elBar.style.width = "0%";
      elIdx.textContent = "1";
      elScore.textContent = "0";
    };
  }

  async function loadAllBanks(){
    const manifestRes = await fetch("./banks.json", { cache: "no-store" });
    if(!manifestRes.ok) throw new Error(`Errore caricamento banks.json (${manifestRes.status})`);
    const manifest = await manifestRes.json();

    if(!manifest || !Array.isArray(manifest.banks) || manifest.banks.length === 0) {
      throw new Error("banks.json non valido o senza banks[]");
    }

    BANKS = manifest.banks;

    // carico tutti i pool (serve per conteggi e per selezione)
    for (const b of BANKS) {
      const res = await fetch("./" + b.file, { cache: "no-store" });
      if(!res.ok) throw new Error(`Errore caricamento ${b.file} (${res.status})`);
      const part = await res.json();
      validateBank(part, b.file);

      // Tag nel topic per distinguere pool
      const questionsTagged = part.map(q => ({ ...q, topic: b.title ? `${b.title} — ${q.topic}` : q.topic }));
      BANK_DATA.set(b.id, { meta: b, questionsTagged, count: questionsTagged.length });
    }

    // default selezione: da localStorage, altrimenti tutto
    const saved = loadSelection();
    if(saved && saved.length){
      // filtra eventuali id non più presenti
      const present = new Set(BANKS.map(b => b.id));
      selectedBankIds = new Set(saved.filter(id => present.has(id)));
      if(selectedBankIds.size === 0) selectedBankIds = new Set(BANKS.map(b => b.id));
    } else {
      selectedBankIds = new Set(BANKS.map(b => b.id));
    }
    saveSelection();

    renderTopicPicker();

    // prima costruzione pool
    const ok = rebuildQuestionBankFromSelection();
    if(!ok) throw new Error("Seleziona argomenti: pool insufficiente (min 10).");
  }

  function buildQuiz(){
    rng = mulberry32(seed);

    const ok = rebuildQuestionBankFromSelection();
    if(!ok) return;

    const pool10 = shuffle(QUESTION_BANK, rng).slice(0, 10);
    quiz = pool10.map(q => shuffleOptionsKeepAnswer(q, rng));

    i = 0;
    score = 0;
    locked = false;

    elSeed.textContent = seed;
    render();
  }

  function render(){
    const q = quiz[i];
    elIdx.textContent = (i + 1);
    elScore.textContent = score;
    elBar.style.width = `${(i/10)*100}%`;

    elTopic.textContent = `Topic: ${q.topic}`;
    elQ.textContent = q.q;

    elOpts.innerHTML = "";
    elFb.innerHTML = "";
    btnNext.disabled = true;
    locked = false;

    q.options.forEach((opt, idx) => {
      const b = document.createElement("button");
      b.className = "opt";
      b.textContent = opt;
      b.onclick = () => choose(idx);
      elOpts.appendChild(b);
    });

    btnNext.textContent = (i === 9) ? "Vedi risultato" : "Avanti";
  }

  function choose(idx){
    if(locked) return;
    locked = true;

    const q = quiz[i];
    const ok = idx === q.answerIndex;

    [...elOpts.querySelectorAll("button.opt")].forEach((b, j) => {
      b.disabled = true;
      if(j === q.answerIndex) b.style.borderColor = "rgba(34,197,94,.8)";
      if(j === idx && !ok) b.style.borderColor = "rgba(239,68,68,.8)";
    });

    if(ok) score++;

    // SOLO SLIDE (link singolo)
    elFb.innerHTML = `
      <div class="feedback ${ok ? "ok" : "bad"}">
        <div style="font-weight:600;margin-bottom:6px;">${ok ? "Corretto" : "Errato"}.</div>
        <div style="color: var(--muted); margin-bottom:8px;">
          <a href="${q.refUrl}" target="_blank" rel="noopener">${q.refLabel}</a>
        </div>
      </div>
    `;

    elScore.textContent = score;
    btnNext.disabled = false;
    elBar.style.width = `${((i+1)/10)*100}%`;
  }

  btnNext.onclick = () => {
    if(i < 9){
      i++;
      render();
    } else {
      elBar.style.width = "100%";
      elTopic.textContent = "Risultato";
      elQ.textContent = `Fine quiz. Score: ${score}/10`;
      elOpts.innerHTML = "";
      elFb.innerHTML = `<div class="feedback">
        <div style="font-weight:600;margin-bottom:6px;">KPI: ${score}/10</div>
        <div class="small">Clicca “Nuovo quiz” per estrarre altre 10 domande random dal pool selezionato.</div>
      </div>`;
      btnNext.disabled = true;
    }
  };

  btnRestart.onclick = () => {
    // se selezione non valida, non riparte
    if(QUESTION_BANK.length < 10){
      alert("Pool selezionato troppo piccolo. Seleziona più argomenti.");
      return;
    }
    seed = Math.floor(Math.random() * 1e9);
    history.replaceState(null, "", setQS("seed", seed));
    buildQuiz();
  };

  btnCopy.onclick = async () => {
    const link = setQS("seed", seed);
    try{
      await navigator.clipboard.writeText(link);
      btnCopy.textContent = "Link copiato";
      setTimeout(()=>btnCopy.textContent="Copia link (stesso seed)", 1200);
    } catch(e){
      prompt("Copia questo link:", link);
    }
  };

  (async function init(){
    history.replaceState(null, "", setQS("seed", seed));
    try{
      await loadAllBanks();
      buildQuiz();
    } catch(err){
      elTopic.textContent = "Errore";
      elQ.textContent = err?.message ? err.message : String(err);
      elOpts.innerHTML = "";
      elFb.innerHTML = "";
      btnNext.disabled = true;
    }
  })();
</script>
</body>
</html>
