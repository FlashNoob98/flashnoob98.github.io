<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Quiz HSE — 10 domande random</title>
  <style>
    :root { --bg:#0b1220; --card:#111a2e; --text:#e9eefc; --muted:#aab6d3; --ok:#22c55e; --bad:#ef4444; --accent:#60a5fa; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; background: var(--bg); color: var(--text); }
    .wrap { max-width: 900px; margin: 24px auto; padding: 0 16px; }
    .card { background: var(--card); border: 1px solid rgba(255,255,255,.08); border-radius: 14px; padding: 18px; box-shadow: 0 10px 30px rgba(0,0,0,.25); }
    h1 { font-size: 20px; margin: 0 0 10px; }
    .meta { color: var(--muted); font-size: 13px; margin-bottom: 14px; display:flex; gap:12px; flex-wrap:wrap; }
    .q { font-size: 16px; margin: 0 0 12px; line-height: 1.35; }
    .opts { display: grid; gap: 10px; }
    button.opt { text-align:left; padding: 12px; border-radius: 12px; border: 1px solid rgba(255,255,255,.12); background: rgba(255,255,255,.04); color: var(--text); cursor:pointer; }
    button.opt:hover { border-color: rgba(96,165,250,.7); }
    button.opt[disabled] { cursor: default; opacity: .92; }
    .feedback { margin-top: 12px; padding: 12px; border-radius: 12px; border: 1px solid rgba(255,255,255,.10); background: rgba(255,255,255,.03); }
    .feedback.ok { border-color: rgba(34,197,94,.6); }
    .feedback.bad { border-color: rgba(239,68,68,.6); }
    a { color: var(--accent); text-decoration: none; }
    a:hover { text-decoration: underline; }
    .controls { display:flex; gap:10px; margin-top: 14px; flex-wrap: wrap; }
    .btn { padding: 10px 12px; border-radius: 12px; border: 1px solid rgba(255,255,255,.14); background: rgba(255,255,255,.05); color: var(--text); cursor:pointer; }
    .btn.primary { border-color: rgba(96,165,250,.7); }
    .progress { height: 8px; background: rgba(255,255,255,.08); border-radius: 999px; overflow:hidden; margin: 14px 0 6px; }
    .bar { height: 100%; width:0%; background: rgba(96,165,250,.9); }
    .small { font-size: 12px; color: var(--muted); }
    .pill { display:inline-flex; align-items:center; gap:6px; padding: 4px 10px; border-radius: 999px; border:1px solid rgba(255,255,255,.12); background: rgba(255,255,255,.04); }
    .score { font-weight: 600; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Quiz HSE — D.Lgs. 81/08 + Rischio Elettrico + Rifiuti + Quota/PLE</h1>
      <div class="meta">
        <span class="pill">Domanda <span id="idx">1</span>/10</span>
        <span class="pill">Punteggio <span class="score" id="score">0</span></span>
        <span class="pill">Seed <span id="seed"></span></span>
        <span class="pill">Pool <span id="poolSize">-</span></span>
      </div>

      <div class="progress"><div class="bar" id="bar"></div></div>
      <div class="small" id="topic"></div>

      <p class="q" id="question"></p>
      <div class="opts" id="options"></div>

      <div id="feedback"></div>

      <div class="controls">
        <button class="btn" id="next" disabled>Avanti</button>
        <button class="btn primary" id="restart">Nuovo quiz</button>
        <button class="btn" id="copyLink">Copia link (stesso seed)</button>
      </div>

      <div class="small" style="margin-top:10px;">
        Question bank esterno: <code>questions.json</code>. Riferimenti: link pubblici (Normattiva / fonti pubbliche).
      </div>
    </div>
  </div>

<script>
  // ====== Normattiva (ricerca veloce) ======
  const NORMATTIVA_BASE = "https://www.normattiva.it/ricerca/veloce/0";
  const TAB_ID = "0";
  function normattivaVeloce(queryText){
    const u = new URL(NORMATTIVA_BASE);
    u.searchParams.set("tabID", TAB_ID);
    u.searchParams.set("title", "lbl.risultatoRicerca");
    u.searchParams.set("initBreadCrumb", "true");
    u.searchParams.set("testo", queryText);
    return u.toString();
  }

  // ====== RNG / shuffle ======
  function mulberry32(a){return function(){let t=a+=0x6D2B79F5;t=Math.imul(t^t>>>15,t|1);t^=t+Math.imul(t^t>>>7,t|61);return((t^t>>>14)>>>0)/4294967296}}
  function shuffle(arr, rng){
    const a = arr.slice();
    for(let i=a.length-1;i>0;i--){
      const j = Math.floor(rng()*(i+1));
      [a[i], a[j]] = [a[j], a[i]];
    }
    return a;
  }

  function shuffleOptionsKeepAnswer(question, rng){
  const opts = question.options.map((text, idx) => ({ text, idx }));
  // shuffle dei pair {text, idxOriginale}
  for(let i = opts.length - 1; i > 0; i--){
    const j = Math.floor(rng() * (i + 1));
    [opts[i], opts[j]] = [opts[j], opts[i]];
  }
  const newOptions = opts.map(o => o.text);
  const newAnswerIndex = opts.findIndex(o => o.idx === question.answerIndex);

  return {
    ...question,
    options: newOptions,
    answerIndex: newAnswerIndex
  };
}

  function qs(name){
    const url = new URL(window.location.href);
    return url.searchParams.get(name);
  }
  function setQS(name, value){
    const url = new URL(window.location.href);
    url.searchParams.set(name, value);
    return url.toString();
  }

  // ====== App state ======
  let seed = Number(qs("seed")) || Math.floor(Math.random()*1e9);
  let rng = mulberry32(seed);
  let QUESTION_BANK = [];
  let quiz = [];
  let i = 0;
  let score = 0;
  let locked = false;

  const elIdx = document.getElementById("idx");
  const elScore = document.getElementById("score");
  const elSeed = document.getElementById("seed");
  const elPool = document.getElementById("poolSize");
  const elBar = document.getElementById("bar");
  const elTopic = document.getElementById("topic");
  const elQ = document.getElementById("question");
  const elOpts = document.getElementById("options");
  const elFb = document.getElementById("feedback");
  const btnNext = document.getElementById("next");
  const btnRestart = document.getElementById("restart");
  const btnCopy = document.getElementById("copyLink");

  function validateBank(bank){
    if(!Array.isArray(bank) || bank.length < 10) throw new Error("Question bank non valido o troppo piccolo (min 10).");
    bank.forEach((q, idx) => {
      const req = ["id","topic","q","options","answerIndex","refLabel","refUrl"];
      req.forEach(k => { if(!(k in q)) throw new Error(`Domanda #${idx} manca campo: ${k}`); });
      if(!Array.isArray(q.options) || q.options.length < 2) throw new Error(`Domanda ${q.id}: options non valide`);
      if(typeof q.answerIndex !== "number" || q.answerIndex < 0 || q.answerIndex >= q.options.length) throw new Error(`Domanda ${q.id}: answerIndex non valido`);
      // helper opzionale: se vuoi, consenti refUrl = { normattivaQuery: "..." }
      if(typeof q.refUrl === "object" && q.refUrl && q.refUrl.normattivaQuery){
        q.refUrl = normattivaVeloce(q.refUrl.normattivaQuery);
      }
    });
  }

  async function loadBank(){
    const res = await fetch("./questions.json", { cache: "no-store" });
    if(!res.ok) throw new Error(`Errore caricamento questions.json (${res.status})`);
    const bank = await res.json();
    validateBank(bank);
    QUESTION_BANK = bank;
    elPool.textContent = String(QUESTION_BANK.length);
  }

function buildQuiz(){
  rng = mulberry32(seed);

  // shuffle pool e prendi 10
  const pool = shuffle(QUESTION_BANK, rng).slice(0, 10);

  // shuffle opzioni per ciascuna domanda (usando lo stesso rng)
  quiz = pool.map(q => shuffleOptionsKeepAnswer(q, rng));

  i = 0;
  score = 0;
  locked = false;
  elSeed.textContent = seed;
  render();
}


  function render(){
    const q = quiz[i];
    elIdx.textContent = (i+1);
    elScore.textContent = score;
    elBar.style.width = `${(i/10)*100}%`;
    elTopic.textContent = `Topic: ${q.topic}`;
    elQ.textContent = q.q;

    elOpts.innerHTML = "";
    elFb.innerHTML = "";
    btnNext.disabled = true;
    locked = false;

    q.options.forEach((opt, idx) => {
      const b = document.createElement("button");
      b.className = "opt";
      b.textContent = opt;
      b.onclick = () => choose(idx);
      elOpts.appendChild(b);
    });

    btnNext.textContent = (i === 9) ? "Vedi risultato" : "Avanti";
  }

  function choose(idx){
    if(locked) return;
    locked = true;

    const q = quiz[i];
    const ok = idx === q.answerIndex;

    [...elOpts.querySelectorAll("button.opt")].forEach((b, j) => {
      b.disabled = true;
      if(j === q.answerIndex) b.style.borderColor = "rgba(34,197,94,.8)";
      if(j === idx && !ok) b.style.borderColor = "rgba(239,68,68,.8)";
    });

    if(ok) score++;

    elFb.innerHTML = `
      <div class="feedback ${ok ? "ok" : "bad"}">
        <div style="font-weight:600;margin-bottom:6px;">
          ${ok ? "Corretto" : "Errato"}.
        </div>
        <div style="color: var(--muted); margin-bottom:8px;">
          Riferimento: <a href="${q.refUrl}" target="_blank" rel="noopener">${q.refLabel}</a>
        </div>
      </div>
    `;

    elScore.textContent = score;
    btnNext.disabled = false;
    elBar.style.width = `${((i+1)/10)*100}%`;
  }

  btnNext.onclick = () => {
    if(i < 9){
      i++;
      render();
    } else {
      elBar.style.width = "100%";
      elQ.textContent = `Fine quiz. Score: ${score}/10`;
      elTopic.textContent = "Risultato";
      elOpts.innerHTML = "";
      elFb.innerHTML = `<div class="feedback">
        <div style="font-weight:600;margin-bottom:6px;">KPI: ${score}/10</div>
        <div class="small">“Nuovo quiz” estrae altre 10 domande random dal pool.</div>
      </div>`;
      btnNext.disabled = true;
    }
  };

  btnRestart.onclick = () => {
    seed = Math.floor(Math.random()*1e9);
    history.replaceState(null, "", setQS("seed", seed));
    buildQuiz();
  };

  btnCopy.onclick = async () => {
    const link = setQS("seed", seed);
    try{
      await navigator.clipboard.writeText(link);
      btnCopy.textContent = "Link copiato";
      setTimeout(()=>btnCopy.textContent="Copia link (stesso seed)", 1200);
    } catch(e){
      prompt("Copia questo link:", link);
    }
  };

  // init
  (async function init(){
    history.replaceState(null, "", setQS("seed", seed));
    try{
      await loadBank();
      buildQuiz();
    } catch(err){
      elTopic.textContent = "Errore caricamento";
      elQ.textContent = err.message || String(err);
      elOpts.innerHTML = "";
      btnNext.disabled = true;
    }
  })();
</script>
</body>
</html>
